<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Barkod SayÄ±m UygulamasÄ±</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    #reader { width: 100%; max-width: 400px; margin: auto; }
    input, button { padding: 10px; margin: 10px; font-size: 16px; }
    table { width: 100%; max-width: 500px; margin: 20px auto; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 10px; }
  </style>
</head>
<body>
  <h1>ðŸ“¦ Barkod SayÄ±m UygulamasÄ±</h1>
  <div id="reader"></div>
  <div id="manualInput" style="display: none;">
    <p>Barkod: <span id="currentBarcode"></span></p>
    <input type="number" id="quantityInput" placeholder="Adet giriniz" />
    <button onclick="addQuantity()">âž• Ekle</button>
  </div>
  <h2>ðŸ“‹ SayÄ±m Listesi</h2>
  <table>
    <thead><tr><th>Barkod</th><th>Adet</th></tr></thead>
    <tbody id="itemList"></tbody>
  </table>
  <button onclick="exportToExcel()">ðŸ“¥ Excel'e Aktar</button>
  <button onclick="testBeep()">ðŸ”Š Test Beep Sesi</button>

  <audio id="beep" preload="auto">
    <source src="https://www.soundjay.com/button/beep-07.mp3" type="audio/mp3" />
    TarayÄ±cÄ±nÄ±z ses etiketini desteklemiyor.
  </audio>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(function(reg) {
        console.log('Service Worker Registered', reg);
      });
    }

    let scannedData = {};
    let currentCode = "";
    const beepSound = document.getElementById("beep");

    function testBeep() {
      beepSound.pause();
      beepSound.currentTime = 0;
      beepSound.play();
    }

    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
      if (devices.length) {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 30, aspectRatio: 1.5, disableFlip: true },
          barcode => handleScan(barcode),
          error => {}
        );
      }
    });

    function handleScan(barcode) {
      html5QrCode.pause();
      testBeep();
      currentCode = barcode;
      document.getElementById("currentBarcode").textContent = barcode;
      document.getElementById("manualInput").style.display = "block";
    }

    function addQuantity() {
      const qty = parseInt(document.getElementById("quantityInput").value);
      if (!qty || qty < 1) return alert("LÃ¼tfen geÃ§erli bir sayÄ± girin");

      if (scannedData[currentCode]) {
        scannedData[currentCode] += qty;
      } else {
        scannedData[currentCode] = qty;
      }

      updateTable();
      document.getElementById("quantityInput").value = "";
      document.getElementById("manualInput").style.display = "none";
      html5QrCode.resume();
    }

    function updateTable() {
      const tbody = document.getElementById("itemList");
      tbody.innerHTML = "";
      for (const code in scannedData) {
        const row = `<tr><td>${code}</td><td>${scannedData[code]}</td></tr>`;
        tbody.innerHTML += row;
      }
    }

    function exportToExcel() {
      const data = Object.keys(scannedData).map(code => ({ Barkod: code, Adet: scannedData[code] }));
      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Sayim");
      XLSX.writeFile(workbook, "sayim_listesi.xlsx");
    }
  </script>
</body>
</html>